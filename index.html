<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>MWFinance ‚Äî v1.4.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0b10;--card:#141421;--muted:#a8a8b3;--border:#2c2c3f;--row:#11111a;--row-alt:#0f0f18;--pos:#75e39a;--neg:#ff8484;--pill:#2a2a3a;--accent:#3c7cff;--link:#9fb8ff;--link-hover:#cfe0ff}
    *{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:var(--bg);color:#eaeaea}
    h1{margin:0 0 8px;font-size:20px}a{color:var(--link);text-decoration:underline}a:hover{color:var(--link-hover)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .muted{color:var(--muted)}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    label{font-size:13px;opacity:.9}input,select,button{background:#1b1b2b;color:#eaeaea;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px}
    button{cursor:pointer;font-weight:600}.btn-link{background:transparent;border:1px solid #2a2a3a;padding:10px 12px;border-radius:10px}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}.btn-danger{background:transparent;border:1px solid #6a2a2a;color:#ff9b9b;padding:6px 10px;border-radius:10px}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#2a2a3a;border:1px solid #3a3a57;margin-right:6px;font-size:12px}
    nav{position:sticky;top:0;z-index:50;margin-bottom:10px}.nav-wrap{background:#12121c;border:1px solid var(--border);border-radius:12px;padding:6px}
    .nav{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none}.nav::-webkit-scrollbar{display:none}
    .nav a{color:#eaeaea;text-decoration:none;border:1px solid var(--border);padding:8px 10px;border-radius:10px;display:inline-flex;gap:6px;align-items:center;white-space:nowrap;flex:0 0 auto}
    .nav a.active{background:var(--accent);border-color:var(--accent);color:#fff}.nav .ic{width:18px;height:18px;display:inline-grid;place-items:center;opacity:.9}
    @media (max-width:560px){.nav a{padding:8px;gap:0}.nav a span.label{display:none}}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px;table-layout:fixed}
    thead th{background:var(--card);border-bottom:1px solid var(--border);padding:8px;text-align:left}
    tbody tr:nth-child(odd):not(.expander){background:var(--row)}tbody tr:nth-child(even):not(.expander){background:var(--row-alt)}
    td{border-bottom:1px solid var(--border);padding:8px;vertical-align:top}.saldo{font-weight:700;text-align:right;white-space:nowrap}
    .saldo-pos{color:var(--pos)}.saldo-neg{color:var(--neg)}.row-neg{outline:2px solid rgba(255,132,132,.18)}
    .day-chip{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;background:#1b1b2b;border:1px solid var(--border);font-weight:700}
    tr.expander td{padding:0;border-bottom:none}.expand-card{background:#12121c;border:1px solid #26263a;border-radius:10px;margin:8px 0 16px;padding:10px 12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .tx-list{list-style:disc;padding-left:18px;margin:0}.tx-list li{margin:6px 0}.col-dia{width:56px}.col-saldo{width:110px}
    @media (max-width:600px){body{margin:10px}h1{font-size:18px}table{font-size:13px}.col-saldo{width:96px}}
    .filters{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}.filters .group{display:flex;flex-direction:column;gap:6px}
    #modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    #modal-backdrop.open{display:flex}.modal{width:100%;max-width:560px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.5)}
    #navBar,[data-sec]{display:none}body.logged #navBar{display:block}[data-sec].show{display:block}
  </style>
</head>
<body>
  <h1>MWFinance</h1>

  <div id="userBar" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="userInfo" class="muted">‚Äî</div>
      <div><button id="btnLogout" class="btn-link">Sair</button></div>
    </div>
  </div>

  <nav id="navBar" class="card nav-wrap">
    <div class="nav">
      <a href="#/saldos" id="nav-saldos"><span class="ic">üìä</span><span class="label">Saldos</span></a>
      <a href="#/contas" id="nav-contas"><span class="ic">üí≥</span><span class="label">Contas</span></a>
      <a href="#/categorias" id="nav-categorias"><span class="ic">üè∑Ô∏è</span><span class="label">Categorias</span></a>
      <a href="#/importar" id="nav-importar"><span class="ic">üì•</span><span class="label">Importar</span></a>
    </div>
  </nav>

  <!-- LOGIN -->
  <div id="authView" class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:700;margin-bottom:6px;">Entrar</div>
        <div class="muted" style="max-width:420px">Use e-mail/senha ou Google. Seus dados ficam isolados por usu√°rio (RLS).</div>
      </div>
    </div>
    <div class="row" style="max-width:520px">
      <div style="flex:1"><label>E-mail</label><br/><input id="email" type="email" placeholder="voce@exemplo.com"/></div>
      <div style="flex:1"><label>Senha</label><br/><input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    </div>
    <div class="row">
      <button id="btnLogin" class="btn-primary">Entrar</button>
      <button id="btnSignup" class="btn-link">Criar conta</button>
      <button id="btnGoogle" class="btn-link">Entrar com Google</button>
      <span id="authMsg" class="muted"></span>
    </div>
  </div>

  <!-- SALDOS -->
  <section id="view-saldos" data-sec>
    <div class="card">
      <div class="section-title">
        <div><strong>Saldos Di√°rios</strong></div>
        <div class="muted">Acompanhe previs√µes e materialize recorr√™ncias ao efetivar.</div>
      </div>
      <div class="filters">
        <div class="group">
          <label for="conta">Conta</label>
          <select id="conta"></select>
        </div>
        <div class="group">
          <label for="mesRef">M√™s</label>
          <input id="mesRef" type="month"/>
        </div>
        <div class="group" style="flex:1"></div>
        <div class="group" style="flex-direction:row; gap:8px;">
          <button id="btnAtualizar">Atualizar</button>
          <button id="btnMesAnterior" title="M√™s anterior">‚óÄÔ∏é</button>
          <button id="btnMesSeguinte" title="Pr√≥ximo m√™s">‚ñ∂Ô∏é</button>
          <button id="btnNova" class="btn-primary">+ Nova Transa√ß√£o</button>
        </div>
      </div>
    </div>
    <div id="output" class="card"><div class="muted">Selecione a conta‚Ä¶</div></div>
  </section>

  <!-- CONTAS -->
  <section id="view-contas" data-sec>
    <div class="card">
      <div class="section-title">
        <div><strong>Contas</strong></div>
        <div class="muted">Crie sua primeira conta com <em>saldo inicial</em> e gerencie as existentes.</div>
      </div>
      <div class="row">
        <div style="flex:1"><label>Nome da conta</label><br/><input id="c_nome" placeholder="Ex.: Conta Corrente Nubank"/></div>
        <div><label>Saldo inicial</label><br/><input id="c_saldo" type="number" step="0.01" value="0"/></div>
        <div style="align-self:flex-end"><button id="btnCriarConta" class="btn-primary">Criar Conta</button></div>
      </div>
    </div>
    <div id="contasLista" class="card"><div class="muted">Carregando‚Ä¶</div></div>
  </section>

  <!-- CATEGORIAS -->
  <section id="view-categorias" data-sec>
    <div class="card">
      <div class="section-title">
        <div><strong>Categorias</strong></div>
        <div class="muted">Organize suas transa√ß√µes por categoria (cr√©dito/d√©bito).</div>
      </div>
      <div class="row">
        <div style="flex:1"><label>Nome</label><br/><input id="cat_nome" placeholder="Ex.: Mercado"/></div>
        <div><label>Tipo</label><br/>
          <select id="cat_tipo"><option value="debito">D√©bito</option><option value="credito">Cr√©dito</option></select>
        </div>
        <div style="flex:1"><label>Descri√ß√£o</label><br/><input id="cat_desc" placeholder="Opcional"/></div>
        <div style="align-self:flex-end"><button id="btnCriarCategoria" class="btn-primary">Criar Categoria</button></div>
      </div>
    </div>
    <div id="categoriasLista" class="card"><div class="muted">Carregando‚Ä¶</div></div>
  </section>

  <!-- IMPORTAR -->
  <section id="view-importar" data-sec>
    <div class="card">
      <div class="section-title">
        <div><strong>Importar CSV</strong></div>
        <div class="muted">Use os templates para importar categorias, transa√ß√µes e recorr√™ncias.</div>
      </div>
      <div class="row">
        <div><label>Tipo</label><br/>
          <select id="imp_tipo">
            <option value="categorias">Categorias</option>
            <option value="transacoes">Transa√ß√µes</option>
            <option value="recorrencias">Recorr√™ncias</option>
          </select>
        </div>
        <div><label>Arquivo CSV</label><br/><input id="imp_file" type="file" accept=".csv"/></div>
        <div style="align-self:flex-end"><button id="btnImportarCsv" class="btn-primary">Importar</button></div>
      </div>
      <div style="margin-top:6px;">
        Templates:
        <a href="./templates/template_categorias.csv" download>template_categorias.csv</a>,
        <a href="./templates/template_transacoes.csv" download>template_transacoes.csv</a>,
        <a href="./templates/template_recorrencias.csv" download>template_recorrencias.csv</a>
      </div>
      <div id="imp_msg" style="margin-top:8px;"></div>
    </div>
  </section>

  <!-- MODAL NOVA/EDITAR -->
  <div id="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 8px; font-size:18px;">Nova Transa√ß√£o</h3>
      <div class="row" style="flex-direction:column; align-items:stretch;">
        <input id="f_mode" type="hidden" value="create"/>
        <input id="f_edit_id" type="hidden" value=""/>
        <input id="f_edit_virtual" type="hidden" value="false"/>

        <label>Tipo do lan√ßamento</label>
        <select id="f_kind">
          <option value="unica" selected>√önica</option>
          <option value="parcelada">Parcelada</option>
          <option value="recorrente">Recorrente</option>
        </select>

        <label>Descri√ß√£o</label>
        <input id="f_descricao" type="text" placeholder="Ex.: Mensalidade academia"/>

        <div class="row" style="gap:10px;">
          <div style="flex:1">
            <label>Tipo</label>
            <select id="f_tipo">
              <option value="debito">D√©bito</option>
              <option value="credito">Cr√©dito</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Valor</label>
            <input id="f_valor" type="number" step="0.01" min="0"/>
          </div>
        </div>

        <label>Data</label>
        <input id="f_data" type="date"/>

        <div id="grpParcelas" style="display:none">
          <label>Quantidade de parcelas</label>
          <input id="f_qtd" type="number" min="2" step="1" placeholder="Ex.: 12"/>
          <small class="muted">Ser√£o lan√ßadas N transa√ß√µes, 1 por m√™s, a partir da data informada.</small>
        </div>

        <div id="grpPeriodicidade" style="display:none">
          <label>Periodicidade</label>
          <select id="f_periodicidade">
            <option value="mensal" selected>Mensal</option>
          </select>
          <small class="muted">Recorr√™ncias s√£o previstas; materialize quando efetivar.</small>
        </div>

        <label>Status</label>
        <select id="f_status">
          <option value="cadastrada" selected>Cadastrada</option>
          <option value="agendada">Agendada</option>
          <option value="efetivada">Efetivada</option>
        </select>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="m_cancel" class="btn-link">Cancelar</button>
        <button id="m_save" class="btn-primary">Salvar</button>
      </div>
      <p id="m_hint" class="muted" style="margin-top:8px;"></p>
    </div>
  </div>

  <script src="./config.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.CONFIG;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true } });

    // ===== Helpers
    const qs = (s)=>document.querySelector(s);
    function money(v){return Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}
    function day(iso){const d=new Date(iso);return isNaN(d)?'':d.getUTCDate()}
    function classSaldo(v){return Number(v||0)<0?'saldo saldo-neg':'saldo saldo-pos'}

    // ===== Router + gate
    const sections={saldos:qs('#view-saldos'),contas:qs('#view-contas'),categorias:qs('#view-categorias'),importar:qs('#view-importar')};
    const nav={saldos:qs('#nav-saldos'),contas:qs('#nav-contas'),categorias:qs('#nav-categorias'),importar:qs('#nav-importar')};
    function cv(){const h=(location.hash||'#/saldos').toLowerCase();if(h.startsWith('#/contas'))return'contas';if(h.startsWith('#/categorias'))return'categorias';if(h.startsWith('#/importar'))return'importar';return'saldos'}
    function show(view){Object.values(sections).forEach(s=>s.classList.remove('show'));Object.values(nav).forEach(a=>a.classList.remove('active'));(sections[view]||sections.saldos).classList.add('show');(nav[view]||nav.saldos).classList.add('active');if(view==='saldos')carregarContas();if(view==='contas')listarContas();if(view==='categorias')listarCategorias()}
    function navigate(view){if(!currentSession)return;location.hash='#/'+view;show(view)}
    window.addEventListener('hashchange',()=>{if(currentSession)show(cv())});
    ['saldos','contas','categorias','importar'].forEach(v=>nav[v].onclick=(e)=>{e.preventDefault();navigate(v)})

    // Sess√£o
    let currentSession=null;
    const $auth=qs('#authView'),$ubar=qs('#userBar'),$uinfo=qs('#userInfo'),$logout=qs('#btnLogout');
    function setLoggedUI(logged){document.body.classList.toggle('logged',logged);$auth.style.display=logged?'none':'block';$ubar.style.display=logged?'block':'none';if(!logged)Object.values(sections).forEach(sec=>sec.classList.remove('show'))}
    function setSession(s){currentSession=s;const logged=!!s?.user;setLoggedUI(logged);$uinfo.textContent=logged?(s.user.email||'Usu√°rio'):'‚Äî';if(logged)show(cv())}

    qs('#btnLogin').onclick=async()=>{try{qs('#authMsg').textContent='Entrando...';const{error}=await supabase.auth.signInWithPassword({email:qs('#email').value.trim(),password:qs('#password').value});if(error){qs('#authMsg').textContent='Erro: '+error.message;return}const{data:{session}}=await supabase.auth.getSession();qs('#authMsg').textContent='';setSession(session);navigate('saldos')}catch(e){qs('#authMsg').textContent='Erro: '+e.message}};
    qs('#btnSignup').onclick=async()=>{try{const{error}=await supabase.auth.signUp({email:qs('#email').value.trim(),password:qs('#password').value});qs('#authMsg').textContent=error?'Erro: '+error.message:'Conta criada. Verifique o e-mail.'}catch(e){qs('#authMsg').textContent='Erro: '+e.message}};
    const PROD_REDIRECT='https://mwfinance.vercel.app';qs('#btnGoogle').onclick=async()=>{const{error}=await supabase.auth.signInWithOAuth({provider:'google',options:{redirectTo:PROD_REDIRECT}});if(error)alert(error.message)};
    $logout.onclick=async()=>{await supabase.auth.signOut();setSession(null)};
    supabase.auth.onAuthStateChange((_e,s)=>{setSession(s);if(location.hash.startsWith('#access_token'))history.replaceState(null,'',location.pathname+location.search)});
    (async()=>{const{data:{session}}=await supabase.auth.getSession();setSession(session);if(session&&!location.hash)navigate('saldos')})();

    // ===== REST helpers
    async function hdr(){if(!currentSession){const{data:{session}}=await supabase.auth.getSession();currentSession=session}if(!currentSession)throw new Error('Sem sess√£o');return{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${currentSession.access_token}`,'Content-Type':'application/json',Prefer:'return=representation'}}
    async function api(m,p,b=null){const r=await fetch(`${SUPABASE_URL}${p}`,{method:m,headers:await hdr(),body:b?JSON.stringify(b):null});if(!r.ok)throw new Error(await r.text());try{return await r.json()}catch{return null}}

    // ===== SALDOS
    const $conta=qs('#conta'),$mesRef=qs('#mesRef'),$out=qs('#output');$mesRef.value=new Date().toISOString().slice(0,7)
    function addMonthsYM(ym,d){const[y,m]=ym.split('-').map(Number);const dt=new Date(Date.UTC(y,m-1,1));dt.setUTCMonth(dt.getUTCMonth()+d);return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,'0')}`}
    qs('#btnAtualizar').onclick=consultar;qs('#btnMesAnterior').onclick=()=>{$mesRef.value=addMonthsYM($mesRef.value,-1);consultar()};qs('#btnMesSeguinte').onclick=()=>{$mesRef.value=addMonthsYM($mesRef.value,+1);consultar()}

    async function carregarContas(){try{const r=await fetch(`${SUPABASE_URL}/rest/v1/contas?select=nome&order=nome.asc`,{headers:await hdr()});if(!r.ok)throw new Error((await r.text())||r.statusText);const contas=await r.json();if(!contas.length){$out.innerHTML='<div class="muted">Nenhuma conta. Crie em <strong>Contas</strong>.</div>';$conta.innerHTML='';return}$conta.innerHTML=contas.map(c=>`<option value="${c.nome}">${c.nome}</option>`).join('');consultar()}catch(e){$out.innerHTML=`<div class="muted">Erro: ${e.message}</div>`}}
    async function consultar(){try{const conta=$conta.value,ym=$mesRef.value;if(!conta||!ym){$out.innerHTML='<div class="muted">Selecione conta e m√™s.</div>';return}const ref=ym+'-01';const r=await fetch(`${SUPABASE_URL}/rest/v1/rpc/saldos_diarios`,{method:'POST',headers:await hdr(),body:JSON.stringify({conta_nome:conta,referencia:ref})});if(!r.ok){$out.innerHTML=`<div class="muted">Erro: ${await r.text()}</div>`;return}renderTabela(await r.json())}catch(e){$out.innerHTML=`<div class="muted">Erro: ${e.message}</div>`}}
    function renderTabela(rows){if(!rows?.length){$out.innerHTML='<div class="muted">Nenhum dado.</div>';return}const body=rows.map((r,i)=>linhaDia(r,i)).join('');$out.innerHTML=`<table><thead><tr><th class="col-dia">Dia</th><th>Transa√ß√µes do dia</th><th class="col-saldo">Saldo</th></tr></thead><tbody>${body}</tbody></table>`;document.querySelectorAll('button.tx-toggle').forEach(b=>b.addEventListener('click',toggleExp));document.querySelectorAll('select.tx-status').forEach(s=>s.addEventListener('change',onChangeStatus));document.querySelectorAll('button.tx-del').forEach(b=>b.addEventListener('click',onDeleteTx));document.querySelectorAll('button.tx-del-rec').forEach(b=>b.addEventListener('click',onDeleteRec));document.querySelectorAll('button.tx-edit').forEach(b=>b.addEventListener('click',onEditTx));document.querySelectorAll('button.tx-mat-edit').forEach(b=>b.addEventListener('click',onMatEdit))}
    function linhaDia(r,i){const txs=Array.isArray(r.transacoes)?r.transacoes:[];const meio=txs.length?`<button class="tx-toggle btn-link" data-exp="exp-${i}" data-count="${txs.length}" aria-expanded="false">‚ñ∫ ${txs.length} transa√ß√£o(√µes)</button>`:`<span class="muted">‚Äì</span>`;const linha=`<tr class="${Number(r.saldo)<0?'row-neg':''}"><td><span class="day-chip">${day(r.dia)}</span></td><td>${meio}</td><td class="${classSaldo(r.saldo)}">${money(r.saldo)}</td></tr>`;const exp=txs.length?`<tr id="exp-${i}" class="expander" style="display:none;"><td colspan="3">${expCard(txs,r.dia)}</td></tr>`:'';return linha+exp}
    function expCard(txs,dia){const items=txs.map(t=>{const select=`<select class="tx-status" data-virtual="${!!t.virtual}" data-id="${t.id||''}" data-recorrencia-id="${t.recorrencia_id||''}" data-conta-id="${t.conta_id||''}" data-data="${t.data||dia}" data-descricao="${(t.descricao||'').replace(/"/g,'&quot;')}" data-tipo="${t.tipo}" data-valor="${t.valor}"><option value="" selected disabled>${t.status||'cadastrada'}</option><option value="cadastrada">Cadastrada</option><option value="agendada">Agendada</option><option value="efetivada">Efetivada</option></select>`;
      const editBtn = t.virtual
        ? `<button class="tx-mat-edit btn-link"
             data-virtual="true" data-recorrencia-id="${t.recorrencia_id||''}" data-conta-id="${t.conta_id||''}"
             data-data="${t.data||dia}" data-descricao="${(t.descricao||'').replace(/"/g,'&quot;')}"
             data-tipo="${t.tipo}" data-valor="${t.valor}" data-status="${t.status||'cadastrada'}">Materializar & editar</button>`
        : `<button class="tx-edit btn-link"
             data-virtual="false" data-id="${t.id}"
             data-data="${t.data}" data-descricao="${(t.descricao||'').replace(/"/g,'&quot;')}"
             data-tipo="${t.tipo}" data-valor="${t.valor}" data-status="${t.status||'cadastrada'}">Editar</button>`;
      const delBtn = t.virtual
        ? `<button class="tx-del-rec btn-danger" data-recorrencia-id="${t.recorrencia_id}">Excluir recorr√™ncia</button>`
        : `<button class="tx-del btn-danger" data-id="${t.id}">Excluir</button>`;
      return `<li><span class="pill">${t.tipo}</span> <strong>${t.descricao}</strong> ‚Äî ${money(t.valor)} ${t.virtual?'<span class="pill">virtual</span>':''}
        <span style="margin-left:8px;display:inline-flex;gap:8px;">${select}${editBtn}${delBtn}</span></li>`;
    }).join('');return `<div class="expand-card"><ul class="tx-list">${items}</ul></div>`}
    function toggleExp(e){const b=e.currentTarget,row=document.getElementById(b.dataset.exp);if(!row)return;const h=row.style.display==='none';row.style.display=h?'':'';b.setAttribute('aria-expanded',h?'true':'false');b.textContent=(h?'‚ñº ':'‚ñ∫ ')+`${b.dataset.count} transa√ß√£o(√µes)`}

    // Status
    async function onChangeStatus(e){const s=e.currentTarget,v=s.value;if(!v)return;const isVirt=s.dataset.virtual==='true';if(isVirt){await api('POST','/rest/v1/transacoes',{recorrencia_id:s.dataset.recorrenciaId||s.dataset['recorrencia-id'],conta_id:s.dataset.contaId||s.dataset['conta-id'],data:s.dataset.data,descricao:s.dataset.descricao,tipo:s.dataset.tipo,valor:Number(s.dataset.valor),status:v})}else{await api('PATCH',`/rest/v1/transacoes?id=eq.${encodeURIComponent(s.dataset.id)}`,{status:v})}consultar()}
    function onDeleteTx(e){const id=e.currentTarget.dataset.id;if(confirm('Excluir transa√ß√£o?'))api('DELETE',`/rest/v1/transacoes?id=eq.${encodeURIComponent(id)}`).then(consultar).catch(err=>alert(err.message))}
    function onDeleteRec(e){const id=e.currentTarget.dataset.recorrenciaId;if(confirm('Excluir recorr√™ncia?'))api('DELETE',`/rest/v1/recorrencias?id=eq.${encodeURIComponent(id)}`).then(consultar).catch(err=>alert(err.message))}

    // ===== Editar / Materializar & editar
    const $modal=qs('#modal-backdrop');
    const f_mode=qs('#f_mode'),f_edit_id=qs('#f_edit_id'),f_edit_virtual=qs('#f_edit_virtual');
    const f_kind=qs('#f_kind'),f_desc=qs('#f_descricao'),f_tipo=qs('#f_tipo'),f_valor=qs('#f_valor'),f_data=qs('#f_data'),f_qtd=qs('#f_qtd'),grpPar=qs('#grpParcelas'),grpPer=qs('#grpPeriodicidade'),f_periodicidade=qs('#f_periodicidade'),f_status=qs('#f_status');
    function openModal(){f_mode.value='create';f_edit_id.value='';f_edit_virtual.value='false';f_kind.disabled=false;f_kind.value='unica';grpPar.style.display='none';grpPer.style.display='none';f_desc.value='';f_tipo.value='debito';f_valor.value='';f_data.value=new Date().toISOString().slice(0,10);f_status.value='cadastrada';qs('#modalTitle').textContent='Nova Transa√ß√£o';qs('#m_hint').textContent='';$modal.classList.add('open');$modal.style.display='flex'}
    function openEditModal({id,virtual,data,descricao,tipo,valor,status}){f_mode.value='edit';f_edit_id.value=id||'';f_edit_virtual.value=virtual?'true':'false';f_kind.value='unica';f_kind.disabled=true;grpPar.style.display='none';grpPer.style.display='none';f_desc.value=descricao||'';f_tipo.value=tipo||'debito';f_valor.value=valor||0;f_data.value=(data||new Date().toISOString().slice(0,10));f_status.value=status||'cadastrada';qs('#modalTitle').textContent=virtual?'Materializar & editar':'Editar Transa√ß√£o';qs('#m_hint').textContent=virtual?'Esta √© uma previs√£o de recorr√™ncia; ao salvar ser√° materializada.':'';$modal.classList.add('open');$modal.style.display='flex'}
    function closeModal(){$modal.classList.remove('open');$modal.style.display='none'}
    qs('#btnNova').onclick=openModal;qs('#m_cancel').onclick=closeModal;$modal.addEventListener('click',e=>{if(e.target===$modal)closeModal()});window.addEventListener('keydown',e=>{if(e.key==='Escape'&&$modal.classList.contains('open'))closeModal()})
    f_kind.addEventListener('change',()=>{grpPar.style.display=(f_kind.value==='parcelada')?'block':'none';grpPer.style.display=(f_kind.value==='recorrente')?'block':'none'})

    function onEditTx(e){const b=e.currentTarget;openEditModal({id:b.dataset.id,virtual:false,data:b.dataset.data,descricao:b.dataset.descricao,tipo:b.dataset.tipo,valor:b.dataset.valor,status:b.dataset.status})}
    function onMatEdit(e){const b=e.currentTarget;openEditModal({id:'',virtual:true,data:b.dataset.data,descricao:b.dataset.descricao,tipo:b.dataset.tipo,valor:b.dataset.valor,status:b.dataset.status})}

    async function getContaIdByNome(n){const r=await api('GET',`/rest/v1/contas?select=id&nome=eq.${encodeURIComponent(n)}`);return Array.isArray(r)&&r[0]?.id}
    async function salvarCreateOrEdit(){
      try{
        const contaNome=qs('#conta').value; const conta_id=await getContaIdByNome(contaNome); if(!conta_id) throw new Error('Conta n√£o encontrada');
        const base={conta_id,descricao:(f_desc.value||'').trim(),tipo:f_tipo.value,valor:Number(f_valor.value||0),data:f_data.value,status:f_status.value};
        if(!base.descricao) throw new Error('Descri√ß√£o √© obrigat√≥ria');
        if(!base.valor||base.valor<=0) throw new Error('Informe um valor > 0');
        if(!base.data) throw new Error('Informe a data');

        if (f_mode.value==='create'){
          if (f_kind.value==='unica'){
            await api('POST','/rest/v1/transacoes', base);
          } else if (f_kind.value==='parcelada'){
            const n=parseInt(f_qtd.value,10); if(!n||n<2) throw new Error('Qtd de parcelas (>=2)');
            const [y,m,d]=base.data.split('-').map(Number); const arr=[];
            for(let i=1;i<=n;i++){const dt=new Date(Date.UTC(y,m-1,d));dt.setUTCMonth(dt.getUTCMonth()+i-1);
              arr.push({conta_id,descricao:`${base.descricao} (${i}/${n})`,tipo:base.tipo,valor:base.valor,data:dt.toISOString().slice(0,10),status:base.status});
            }
            await api('POST','/rest/v1/transacoes', arr);
          } else {
            await api('POST','/rest/v1/recorrencias', {conta_id,descricao:base.descricao,tipo:base.tipo,valor:base.valor,inicio:base.data,fim:null,periodicidade:'mensal'});
          }
        } else { // edit
          const isVirtual = f_edit_virtual.value==='true';
          if (isVirtual){
            // materializa diretamente com os dados editados
            await api('POST','/rest/v1/transacoes', base);
          } else {
            await api('PATCH', `/rest/v1/transacoes?id=eq.${encodeURIComponent(f_edit_id.value)}`, base);
          }
        }
        closeModal(); consultar();
      }catch(err){ alert('Erro ao salvar: '+err.message); }
    }
    qs('#m_save').onclick = salvarCreateOrEdit;

    // ===== Contas
    async function listarContas(){try{const r=await api('GET','/rest/v1/contas?select=id,nome,saldo_inicial&order=nome.asc');const el=qs('#contasLista');if(!r?.length){el.innerHTML='<div class="muted">Nenhuma conta.</div>';return}el.innerHTML=r.map(c=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:6px 0;"><div><strong>${c.nome}</strong> <span class="muted">‚Äî saldo inicial: ${money(c.saldo_inicial)}</span></div><div><button class="btn-link" data-id="${c.id}" data-action="edit">Editar</button><button class="btn-danger" data-id="${c.id}" data-action="del">Excluir</button></div></div>`).join('');Array.from(el.querySelectorAll('button')).forEach(b=>{const id=b.dataset.id,a=b.dataset.action;if(a==='del')b.onclick=()=>{if(confirm('Excluir conta?'))api('DELETE',`/rest/v1/contas?id=eq.${encodeURIComponent(id)}`).then(listarContas).catch(e=>alert(e.message))};if(a==='edit')b.onclick=()=>{const nome=prompt('Novo nome da conta:');if(!nome)return;const saldo=prompt('Novo saldo inicial:','0');if(saldo===null)return;api('PATCH',`/rest/v1/contas?id=eq.${encodeURIComponent(id)}`,{nome,saldo_inicial:Number(saldo)}).then(listarContas).catch(e=>alert(e.message))}})}catch(e){qs('#contasLista').innerHTML=`<div class="muted">Erro: ${e.message}</div>`}}
    qs('#btnCriarConta').onclick=async()=>{try{const nome=(qs('#c_nome').value||'').trim();const saldo=Number(qs('#c_saldo').value||0);if(!nome)return alert('Informe o nome.');await api('POST','/rest/v1/contas',{nome,saldo_inicial:saldo});qs('#c_nome').value='';qs('#c_saldo').value='0';listarContas()}catch(e){alert(e.message)}}

    // ===== Categorias
    async function listarCategorias(){try{const r=await api('GET','/rest/v1/categorias?select=id,nome,tipo,descricao&order=nome.asc');const el=qs('#categoriasLista');if(!r?.length){el.innerHTML='<div class="muted">Nenhuma categoria.</div>';return}el.innerHTML=r.map(c=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:6px 0;"><div><strong>${c.nome}</strong> <span class="pill">${c.tipo}</span> <span class="muted">${c.descricao||''}</span></div><div><button class="btn-link" data-id="${c.id}" data-action="edit">Editar</button><button class="btn-danger" data-id="${c.id}" data-action="del">Excluir</button></div></div>`).join('');Array.from(el.querySelectorAll('button')).forEach(b=>{const id=b.dataset.id,a=b.dataset.action;if(a==='del')b.onclick=()=>{if(confirm('Excluir categoria?'))api('DELETE',`/rest/v1/categorias?id=eq.${encodeURIComponent(id)}`).then(listarCategorias).catch(e=>alert(e.message))};if(a==='edit')b.onclick=()=>{const nome=prompt('Novo nome:');if(!nome)return;const tipo=prompt('Tipo (debito/credito):','debito');if(!tipo)return;const desc=prompt('Descri√ß√£o:','')||'';api('PATCH',`/rest/v1/categorias?id=eq.${encodeURIComponent(id)}`,{nome,tipo,descricao:desc}).then(listarCategorias).catch(e=>alert(e.message))}})}catch(e){qs('#categoriasLista').innerHTML=`<div class="muted">Erro: ${e.message}</div>`}}
    qs('#btnCriarCategoria').onclick=async()=>{try{const nome=(qs('#cat_nome').value||'').trim();const tipo=qs('#cat_tipo').value;const descricao=(qs('#cat_desc').value||'').trim();if(!nome)return alert('Informe o nome.');await api('POST','/rest/v1/categorias',{nome,tipo,descricao});qs('#cat_nome').value='';qs('#cat_desc').value='';listarCategorias()}catch(e){alert(e.message)}}

    // ===== Importa√ß√£o
    function parseCsv(t){const lines=t.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);const headers=lines.shift().split(',').map(h=>h.trim());return lines.map(line=>{const cols=line.split(',');const o={};headers.forEach((h,i)=>o[h]=(cols[i]||'').trim());return o})}
    qs('#btnImportarCsv').onclick=async()=>{try{const tipo=qs('#imp_tipo').value;const file=qs('#imp_file').files[0];if(!file)return alert('Selecione um CSV.');const text=await file.text(),data=parseCsv(text);if(!data.length)return alert('CSV vazio.');let path='/rest/v1/'+(tipo==='categorias'?'categorias':tipo==='transacoes'?'transacoes':'recorrencias');await api('POST',path,data);qs('#imp_msg').innerHTML=`<span class="pill">OK</span> ${data.length} registros importados em <strong>${tipo}</strong>.`}catch(e){qs('#imp_msg').innerHTML=`<span class="pill">ERRO</span> ${e.message}`}}

  </script>
</body>
</html>
