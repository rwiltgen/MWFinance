<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>MWFinance — Saldos Diários</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b10;
      --card: #141421;
      --muted: #a8a8b3;
      --border: #2c2c3f;
      --row: #11111a;
      --row-alt: #0f0f18;
      --pos: #75e39a;
      --neg: #ff8484;
      --pill: #2a2a3a;
      --shadow: rgba(0,0,0,.35);
      --accent: #3c7cff;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: var(--bg); color: #eaeaea; }
    h1 { margin: 0 0 8px; font-size: 20px; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; margin-bottom: 12px; box-shadow: 0 6px 24px var(--shadow); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
    label { font-size: 13px; opacity: .9; }
    input, select, button {
      background: #1b1b2b; color: #eaeaea; border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; font-size: 14px;
    }
    button { cursor: pointer; font-weight: 600; }
    button[disabled] { opacity: .5; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; table-layout: fixed; }
    thead th {
      position: sticky; top: 0; background: var(--card);
      border-bottom: 1px solid var(--border); padding: 8px; text-align: left;
    }
    tbody tr:nth-child(odd):not(.expander) { background: var(--row); }
    tbody tr:nth-child(even):not(.expander) { background: var(--row-alt); }
    td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: top; }

    .saldo { font-weight: 700; text-align: right; white-space: nowrap; }
    .saldo-pos { color: var(--pos); }
    .saldo-neg { color: var(--neg); }
    .row-neg { outline: 2px solid rgba(255, 132, 132, .18); }
    .muted { color: var(--muted); }

    .tools { display:flex; gap:6px; align-items:center; }

    .day-chip {
      display:inline-flex; align-items:center; justify-content:center;
      width: 34px; height: 34px; border-radius: 50%;
      background:#1b1b2b; border:1px solid var(--border); font-weight:700;
    }

    .btn-link { background: transparent; border: 1px solid var(--pill); padding: 4px 8px; border-radius: 8px; font-size: 12px; }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }

    .tx-actions { display:inline-flex; gap:6px; align-items:center; margin-left:6px; flex-wrap: wrap; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--pill); margin-right: 6px; }
    .credit { color: var(--pos); }
    .debit  { color: var(--neg); }

    .col-dia   { width: 56px; }
    .col-saldo { width: 110px; }
    @media (max-width: 600px) {
      body { margin: 10px; }
      h1 { font-size: 18px; }
      table { font-size: 13px; }
      .col-saldo { width: 96px; }
    }

    tr.expander td { padding: 0; border-bottom: none; }
    .expand-card {
      background: #12121c;
      border: 1px solid #26263a;
      border-radius: 10px;
      margin: 8px 0 16px;
      padding: 10px 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .expand-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .expand-header .badge-count {
      font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid #2a2a3a; background:#1e1e2a;
    }
    .tx-list { list-style: disc; padding-left: 18px; margin:0; }
    .tx-list li { margin: 6px 0; }
  </style>
</head>
<body>
  <h1>MWFinance — Saldos Diários</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="conta">Conta</label><br/>
        <select id="conta"></select>
      </div>
      <div>
        <label for="mesRef">Mês</label><br/>
        <input id="mesRef" type="month"/>
      </div>
      <div class="tools" style="align-self:flex-end;">
        <button id="btnAtualizar">Atualizar</button>
        <button id="btnMesAnterior" title="Mês anterior">◀︎</button>
        <button id="btnMesSeguinte" title="Próximo mês">▶︎</button>
        <button id="btnNova" class="btn-primary">+ Nova Transação</button>
      </div>
    </div>
  </div>

  <div id="output" class="card">
    <div class="muted">Carregando contas…</div>
  </div>

  <!-- Modal -->
  <div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000;">
    <div class="modal" style="width:100%; max-width:520px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;">
      <h3 id="modalTitle" style="margin:0 0 8px; font-size:18px;">Edição de transação</h3>
      <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div style="grid-column:1 / -1; display:flex; flex-direction:column; gap:6px;">
          <label>Descrição</label>
          <input id="m_descricao" type="text"/>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label>Tipo</label>
          <select id="m_tipo">
            <option value="credito">Crédito</option>
            <option value="debito">Débito</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label>Valor</label>
          <input id="m_valor" type="number" step="0.01"/>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label>Data</label>
          <input id="m_data" type="date"/>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label>Status</label>
          <select id="m_status">
            <option value="cadastrada">Cadastrada</option>
            <option value="agendada">Agendada</option>
            <option value="efetivada">Efetivada</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="m_cancel" class="btn-link">Cancelar</button>
        <button id="m_save" class="btn-primary">Salvar</button>
      </div>
      <p id="m_hint" style="font-size:12px; color:#bfbfd1; margin-top:8px;"></p>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.CONFIG;
    const headers = { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json', Prefer: 'return=representation' };

    const $conta   = document.getElementById('conta');
    const $mesRef  = document.getElementById('mesRef');
    const $btn     = document.getElementById('btnAtualizar');
    const $btnPrev = document.getElementById('btnMesAnterior');
    const $btnNext = document.getElementById('btnMesSeguinte');
    const $btnNova = document.getElementById('btnNova');
    const $out     = document.getElementById('output');

    const $modal     = document.getElementById('modal');
    const m_title    = document.getElementById('modalTitle');
    const m_desc     = document.getElementById('m_descricao');
    const m_tipo     = document.getElementById('m_tipo');
    const m_valor    = document.getElementById('m_valor');
    const m_data     = document.getElementById('m_data');
    const m_status   = document.getElementById('m_status');
    const m_hint     = document.getElementById('m_hint');

    let modalState = null;

    const today = new Date();
    $mesRef.value = `${today.getUTCFullYear()}-${String(today.getUTCMonth()+1).padStart(2,'0')}`;

    function money(v){ return Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function dayOnly(iso){ const d=new Date(iso); return isNaN(d)?iso:d.getUTCDate(); }
    function classSaldo(v){ return Number(v||0)<0?'saldo saldo-neg':'saldo saldo-pos'; }
    function addMonthsYM(ym,delta){ const [y,m]=ym.split('-').map(Number); const d=new Date(Date.UTC(y,m-1,1)); d.setUTCMonth(d.getUTCMonth()+delta); return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`; }

    async function carregarContas() {
      const url = `${SUPABASE_URL}/rest/v1/contas?select=nome&order=nome.asc`;
      const res = await fetch(url, { headers });
      const contas = await res.json();
      $conta.innerHTML = contas.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
      consultar();
    }

    async function consultar() {
      const conta = $conta.value, ym = $mesRef.value;
      const referencia = ym+'-01';
      const url = `${SUPABASE_URL}/rest/v1/rpc/saldos_diarios`;
      const res = await fetch(url, { method:'POST', headers, body: JSON.stringify({ conta_nome: conta, referencia }) });
      const rows = await res.json();
      renderTabela(rows);
    }

    function renderTabela(rows){
      const tbody = rows.map((r, idx)=>renderLinhaDia(r, idx)).join('');
      $out.innerHTML = `<table><thead><tr><th class="col-dia">Dia</th><th>Transações do dia</th><th class="col-saldo">Saldo</th></tr></thead><tbody>${tbody}</tbody></table>`;
      document.querySelectorAll('button.tx-toggle').forEach(btn=>btn.addEventListener('click', onToggleExpander));
      document.querySelectorAll('select.tx-status').forEach(sel=>sel.addEventListener('change', onChangeStatus));
      document.querySelectorAll('button.tx-edit').forEach(btn=>btn.addEventListener('click', onEdit));
    }

    function renderLinhaDia(r, idx){
      const txs = Array.isArray(r.transacoes)?r.transacoes:[];
      const meio = txs.length
        ? `<button class="tx-toggle btn-link" data-expander="exp-${idx}" aria-expanded="false" data-count="${txs.length}">► ${txs.length} transação(ões)</button>`
        : `<span class="muted">–</span>`;
      const linha = `<tr><td><span class="day-chip">${dayOnly(r.dia)}</span></td><td>${meio}</td><td class="${classSaldo(r.saldo)}">${money(r.saldo)}</td></tr>`;
      const exp = txs.length?`<tr id="exp-${idx}" class="expander" style="display:none;"><td colspan="3">${renderExpanderCard(txs,r.dia)}</td></tr>`:'';
      return linha+exp;
    }

    function renderExpanderCard(txs,diaIso){
      return `<div class="expand-card"><ul class="tx-list">${txs.map(t=>`
        <li>
          <span class="pill ${t.tipo==='credito'?'credit':'debit'}">${t.tipo}</span>
          <strong>${t.descricao}</strong> — ${money(t.valor)}
          <select class="tx-status" data-id="${t.id}" data-conta-id="${t.conta_id}" data-data="${t.data||diaIso}" data-descricao="${t.descricao}" data-tipo="${t.tipo}" data-valor="${t.valor}">
            <option value="cadastrada" ${t.status==='cadastrada'?'selected':''}>Cadastrada</option>
            <option value="agendada" ${t.status==='agendada'?'selected':''}>Agendada</option>
            <option value="efetivada" ${t.status==='efetivada'?'selected':''}>Efetivada</option>
          </select>
          <button class="tx-edit btn-link" data-id="${t.id}" data-conta-id="${t.conta_id}" data-data="${t.data||diaIso}" data-descricao="${t.descricao}" data-tipo="${t.tipo}" data-valor="${t.valor}" data-status="${t.status}">Editar</button>
        </li>`).join('')}</ul></div>`;
    }

    function onToggleExpander(e){ const btn=e.currentTarget; const row=document.getElementById(btn.dataset.expander); const hidden=window.getComputedStyle(row).display==='none'; row.style.display=hidden?'':'none'; btn.textContent=(hidden?'▼ ':'► ')+btn.dataset.count+' transação(ões)'; }

    async function onChangeStatus(e){ const sel=e.currentTarget; await patchTransacao(sel.dataset.id,{status:sel.value}); await consultar(); }

    async function patchTransacao(id,bodyObj){ const url=`${SUPABASE_URL}/rest/v1/transacoes?id=eq.${encodeURIComponent(id)}`; await fetch(url,{method:'PATCH',headers,body:JSON.stringify(bodyObj)}); }

    async function criarTransacao(bodyObj){ const url=`${SUPABASE_URL}/rest/v1/transacoes`; await fetch(url,{method:'POST',headers,body:JSON.stringify(bodyObj)}); }

    function openModal(state){ modalState=state; m_title.textContent=state.novo?'Nova Transação':'Edição de transação'; m_desc.value=state.descricao||''; m_tipo.value=state.tipo||'debito'; m_valor.value=state.valor||0; m_data.value=(state.data||new Date().toISOString().slice(0,10)); m_status.value=state.status||'cadastrada'; m_hint.textContent=state.novo?'Crie uma nova transação para esta conta.':'Edite a transação.'; $modal.style.display='flex'; }
    function closeModal(){ $modal.style.display='none'; modalState=null; }

    document.getElementById('m_cancel').addEventListener('click', closeModal);
    document.getElementById('m_save').addEventListener('click', async ()=>{ 
      const payload={descricao:m_desc.value,tipo:m_tipo.value,valor:Number(m_valor.value),data:m_data.value,status:m_status.value,conta_id:$conta.value};
      if(modalState.novo){ await criarTransacao(payload);} else { await patchTransacao(modalState.id,payload);} 
      closeModal(); await consultar();
    });

    async function onEdit(e){ const btn=e.currentTarget; openModal({novo:false,id:btn.dataset.id,descricao:btn.dataset.descricao,tipo:btn.dataset.tipo,valor:btn.dataset.valor,data:btn.dataset.data,status:btn.dataset.status}); }

    $btnPrev.addEventListener('click',()=>{ $mesRef.value=addMonthsYM($mesRef.value,-1); consultar(); });
    $btnNext.addEventListener('click',()=>{ $mesRef.value=addMonthsYM($mesRef.value,+1); consultar(); });
    $btn.add
